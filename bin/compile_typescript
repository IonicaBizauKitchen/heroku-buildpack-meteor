#!/usr/bin/env bash
# USAGE: bin/compile_typescript <build-dir> <cache-dir> <env-dir>

####### Configure environment

set -e  # fail fast

###### NEEDED VARIABLES/DIRECTORIES

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
APP_SOURCE=$BUILD_DIR/app_src
METEOR_HOME=$BUILD_DIR/.meteor_tool
PATH=$METEOR_HOME:$BUILD_DIR/.heroku/node/bin:$PATH
bp_dir=$(cd $(dirname $0); cd ..; pwd)
TYPESCRIPT_VERSION=1.4

# Load some convenience functions like status(), echo(), and indent()
source $bp_dir/bin/common.sh

build() {
  (
    npm install -g typescript@${TYPESCRIPT_VERSION}
    head "Installing typescript..."
    cd $APP_SOURCE
    sh list-ts-files.sh
    SOURCE_MAP_FLAG=""
    if [[ -f "${ENV_DIR}/DEBUG" ]]; then
      SOURCE_MAP_FLAG="--sourceMap";
    fi
    head "Compiling typescript files..."
    tsc @ts-files.txt ${SOURCE_MAP_FLAG}
  )
}

build
